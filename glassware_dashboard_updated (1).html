<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glassware Procurement Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f5f7fa;
            color: #2d3748;
            padding: 24px;
        }
        .container { max-width: 1920px; margin: 0 auto; }
        
        .header {
            background: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        h1 { font-size: 28px; color: #1a202c; margin-bottom: 8px; }
        .subtitle { font-size: 14px; color: #718096; }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        .kpi-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-top: 4px solid var(--color);
        }
        .kpi-label { font-size: 12px; color: #718096; font-weight: 600; text-transform: uppercase; margin-bottom: 8px; }
        .kpi-value { font-size: 32px; font-weight: 700; color: #1a202c; margin-bottom: 4px; }
        .kpi-desc { font-size: 13px; color: #718096; }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            margin-bottom: 24px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .card.full-width { grid-column: 1 / -1; }
        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-title { font-size: 18px; font-weight: 700; color: #1a202c; }
        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .badge-success { background: #c6f6d5; color: #22543d; }
        .badge-info { background: #bee3f8; color: #2c5282; }
        .badge-warning { background: #feebc8; color: #7c2d12; }
        .badge-danger { background: #fed7d7; color: #742a2a; }
        .card-body { padding: 24px; position: relative; }
        .chart-container { width: 100%; height: 450px; position: relative; }
        
        .tooltip {
            position: absolute;
            background: #1a202c;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            min-width: 200px;
        }
        .tooltip.active { opacity: 1; }
        .tooltip-title {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding-bottom: 6px;
        }
        .tooltip-row {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
            font-size: 12px;
        }
        .tooltip-label { color: #cbd5e0; }
        .tooltip-value { font-weight: 600; color: white; }
        
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        thead { background: #f7fafc; position: sticky; top: 0; }
        th {
            padding: 12px;
            text-align: left;
            font-weight: 700;
            color: #2d3748;
            border-bottom: 2px solid #e2e8f0;
            font-size: 11px;
            text-transform: uppercase;
        }
        td { padding: 12px; border-bottom: 1px solid #e2e8f0; }
        tr:hover { background: #f7fafc; }
        .vendor-best { background: #c6f6d5; color: #22543d; padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 12px; }
        .rate-cell { text-align: right; font-weight: 600; }

        @media (max-width: 1200px) {
            .charts-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Glassware Procurement Dashboard</h1>
            <div class="subtitle">Annual Rate Contract (ARC) Proposal 2024-25 - Vendor Comparison & Missed Savings Analysis</div>
        </div>

        <!-- KPI Cards -->
        <div class="kpi-grid">
            <div class="kpi-card" style="--color: #4299e1;">
                <div class="kpi-label">Total Items</div>
                <div class="kpi-value">180</div>
                <div class="kpi-desc">Glassware items for procurement</div>
            </div>
            <div class="kpi-card" style="--color: #48bb78;">
                <div class="kpi-label">Actual Savings Realized</div>
                <div class="kpi-value">₹26.15L</div>
                <div class="kpi-desc">73.4% of potential captured</div>
            </div>
            <div class="kpi-card" style="--color: #ed8936;">
                <div class="kpi-label">Missed Savings</div>
                <div class="kpi-value">₹9.46L</div>
                <div class="kpi-desc">26.6% opportunity lost</div>
            </div>
            <div class="kpi-card" style="--color: #9f7aea;">
                <div class="kpi-label">Total Potential</div>
                <div class="kpi-value">₹35.60L</div>
                <div class="kpi-desc">Actual + Missed savings</div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="charts-grid">
            <!-- Savings by Vendor (MOVED TO FIRST POSITION) -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Savings by Vendor</div>
                    <span class="badge badge-success">Potential Savings</span>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="savingsCanvas"></canvas>
                        <div id="savingsTooltip" class="tooltip"></div>
                    </div>
                </div>
            </div>

            <!-- Missed Savings by Category (NEW) -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Missed Savings by Category</div>
                    <span class="badge badge-danger">Opportunity Loss</span>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="missedCategoryCanvas"></canvas>
                        <div id="missedCategoryTooltip" class="tooltip"></div>
                    </div>
                </div>
            </div>

            <!-- Top 10 Missed Savings Items (NEW) -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Top 10 Items - Highest Missed Savings</div>
                    <span class="badge badge-warning">Critical Items</span>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="topMissedCanvas"></canvas>
                        <div id="topMissedTooltip" class="tooltip"></div>
                    </div>
                </div>
            </div>

            <!-- Actual vs Missed Savings Breakdown (NEW DONUT CHART) -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Savings Realization Analysis</div>
                    <span class="badge badge-info">Actual vs Missed</span>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="savingsDonutCanvas"></canvas>
                        <div id="savingsDonutTooltip" class="tooltip"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Items Table with Vendor Comparison -->
        <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
                <div class="card-title">Top 20 High-Value Items - Vendor Rate Comparison</div>
                <span class="badge badge-success">Price Analysis</span>
            </div>
            <div class="card-body">
                <table id="topItemsTable"></table>
            </div>
        </div>

        <!-- Vendor Details Table -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">Vendor Comparison Summary</div>
                <span class="badge badge-info">Complete Analysis</span>
            </div>
            <div class="card-body">
                <table id="vendorTable"></table>
            </div>
        </div>
    </div>

    <script>
        // GLASSWARE DATA
        const glasswareData = {
            vendors: [
                { name: 'Tharmo', purchase: 9089278.56, savings: 4146369.44, savingsPct: 45.6 },
                { name: 'J-SIL', purchase: 7603604.45, savings: 5632043.55, savingsPct: 74.1 },
                { name: 'Dodal', purchase: 13235648.00, savings: 500000.00, savingsPct: 3.8 }
            ],
            
            topItems: [
                { name: 'VOLUMETRIC FLASK A CLASS CLEAR USP 5ML', santosh: 331.5, global: 509.48, dodal: 684.8, tharmo: 50948, jsil: 33150, minRate: 331.5, vendor: 'Santosh' },
                { name: 'VOLUMETRIC FLASK A CLASS AMBER USP 5ML', santosh: 500.5, global: 623.22, dodal: 857.6, tharmo: 62322, jsil: 50050, minRate: 500.5, vendor: 'Santosh' },
                { name: 'VOLUMETRIC FLASK A CLASS CLEAR USP 10ML', santosh: 331.5, global: 440.625, dodal: 592, tharmo: 440625, jsil: 331500, minRate: 331.5, vendor: 'Santosh' },
                { name: 'VOLUMETRIC FLASK A CLASS AMBER USP 10ML', santosh: 500.5, global: 531.805, dodal: 752, tharmo: 265902.5, jsil: 250250, minRate: 500.5, vendor: 'Global' },
                { name: 'VOLUMETRIC FLASK A CLASS CLEAR USP 20ML', santosh: 357.5, global: 442.975, dodal: 592, tharmo: 221487.5, jsil: 178750, minRate: 357.5, vendor: 'Santosh' },
                { name: 'VOLUMETRIC FLASK A CLASS AMBER USP 20ML', santosh: 487.5, global: 531.805, dodal: 752, tharmo: 265902.5, jsil: 243750, minRate: 487.5, vendor: 'Santosh' },
                { name: 'VOLUMETRIC FLASK A CLASS CLEAR USP 50ML', santosh: 351, global: 388.22, dodal: 640, tharmo: 194110, jsil: 175500, minRate: 351, vendor: 'Santosh' },
                { name: 'VOLUMETRIC FLASK A CLASS AMBER USP 50ML', santosh: 481, global: 472.115, dodal: 665.6, tharmo: 236057.5, jsil: 240500, minRate: 472.115, vendor: 'Global' },
                { name: 'VOLUMETRIC FLASK A CLASS CLEAR USP 100ML', santosh: 357.5, global: 380.7, dodal: 672, tharmo: 380700, jsil: 357500, minRate: 357.5, vendor: 'Global' },
                { name: 'VOLUMETRIC FLASK A CLASS AMBER USP 100ML', santosh: 487.5, global: 470.94, dodal: 649.6, tharmo: 235470, jsil: 243750, minRate: 470.94, vendor: 'Global' },
                { name: 'VOLUMETRIC FLASK A CLASS CLEAR USP 200ML', santosh: 487.5, global: 531.805, dodal: 790.4, tharmo: 53180.5, jsil: 48750, minRate: 487.5, vendor: 'Santosh' },
                { name: 'VOLUMETRIC FLASK A CLASS AMBER USP 200ML', santosh: 591.5, global: 650.245, dodal: 918.4, tharmo: 32512.25, jsil: 29575, minRate: 591.5, vendor: 'Santosh' },
                { name: 'VOLUMETRIC FLASK A CLASS CLEAR USP 250ML', santosh: 494, global: 534.39, dodal: 851.2, tharmo: 53439, jsil: 49400, minRate: 494, vendor: 'Santosh' },
                { name: 'VOLUMETRIC FLASK A CLASS AMBER USP 250ML', santosh: 607.75, global: 652.595, dodal: 921.6, tharmo: 32629.75, jsil: 30387.5, minRate: 607.75, vendor: 'Global' },
                { name: 'VOLUMETRIC FLASK A CLASS CLEAR USP 500ML', santosh: 624, global: 704.53, dodal: 1059.2, tharmo: 70453, jsil: 62400, minRate: 624, vendor: 'Santosh' },
                { name: 'VOLUMETRIC FLASK A CLASS AMBER USP 500ML', santosh: 851.5, global: 860.1, dodal: 1212.8, tharmo: 43005, jsil: 42575, minRate: 851.5, vendor: 'Global' },
                { name: 'VOLUMETRIC FLASK A CLASS CLEAR USP 1000ML', santosh: 916.5, global: 1025.54, dodal: 1536, tharmo: 205108, jsil: 183300, minRate: 916.5, vendor: 'Santosh' },
                { name: 'VOLUMETRIC FLASK A CLASS AMBER USP 1000ML', santosh: 1163.5, global: 1253.49, dodal: 1769.6, tharmo: 125349, jsil: 116350, minRate: 1163.5, vendor: 'Santosh' },
                { name: 'VOLUMETRIC PIPETTE 1ML CLASS A USP', santosh: 188.5, global: 187.577, dodal: 265.6, tharmo: 18757.7, jsil: 18850, minRate: 187.577, vendor: 'Global' },
                { name: 'VOLUMETRIC PIPETTE 2ML CLASS A USP', santosh: 195, global: 210.654, dodal: 297.6, tharmo: 21065.4, jsil: 19500, minRate: 195, vendor: 'Santosh' }
            ]
        };

        // MISSED SAVINGS DATA
        const missedSavingsData = {
            categories: [
                { name: 'Flasks', totalSaving: 1208300, missed: 625200, count: 62 },
                { name: 'Other', totalSaving: 1880000, missed: 4500, count: 38 },
                { name: 'Pipettes', totalSaving: 179000, missed: 271000, count: 29 },
                { name: 'Cylinders', totalSaving: 159200, missed: 0, count: 15 },
                { name: 'Scoops', totalSaving: 125000, missed: 4000, count: 7 },
                { name: 'Beakers', totalSaving: 8900, missed: 41000, count: 15 }
            ],
            
            topMissed: [
                { name: 'VOLUMETRIC FLASK 2000 ML', missed: 69825 },
                { name: 'VOLUMETRIC FLASK 1000 ML', missed: 35370 },
                { name: 'FILTRATION FLASK 2 LTR', missed: 34440 },
                { name: 'BEAKER 10 LTR', missed: 30000 },
                { name: 'VOLUMATRIC FLASK 500ML - AMBER', missed: 29700 },
                { name: 'VOLUMETRIC FLASK 500ML', missed: 25875 },
                { name: 'VOLUMETRIC FLASK 500ML', missed: 25875 },
                { name: 'VOLUMETRIC FLASK 250 ML - AMBER', missed: 25200 },
                { name: 'VOLUMETRIC FLASK 200ML AMBER', missed: 23232 },
                { name: 'VOLUMETRIC FLASK 200ML AMBER', missed: 23232 }
            ],
            
            plants: [
                { name: 'PTN', totalSaving: 1271273.6, missed: 735960 },
                { name: 'CTGN', totalSaving: 1672241, missed: 209757 },
                { name: 'PTMR', totalSaving: 337925, missed: 0 },
                { name: 'GWHT', totalSaving: 117735, missed: 0 },
                { name: 'CKT', totalSaving: 63323, missed: 0 },
                { name: 'WLJ-API', totalSaving: 97807, missed: 0 }
            ]
        };

        function showTooltip(tooltipEl, x, y, content) {
            tooltipEl.innerHTML = content;
            
            // Get tooltip dimensions after setting content
            tooltipEl.style.opacity = '0';
            tooltipEl.classList.add('active');
            const tooltipRect = tooltipEl.getBoundingClientRect();
            const tooltipWidth = tooltipRect.width;
            const tooltipHeight = tooltipRect.height;
            
            // Get viewport dimensions
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            // Calculate initial position
            let left = x + 15;
            let top = y + 15;
            
            // Adjust horizontal position if tooltip would go off right edge
            if (left + tooltipWidth > viewportWidth - 20) {
                left = x - tooltipWidth - 15;
            }
            
            // Adjust vertical position if tooltip would go off bottom edge
            if (top + tooltipHeight > viewportHeight - 20) {
                top = y - tooltipHeight - 15;
            }
            
            // Ensure tooltip doesn't go off left edge
            if (left < 20) {
                left = 20;
            }
            
            // Ensure tooltip doesn't go off top edge
            if (top < 20) {
                top = 20;
            }
            
            tooltipEl.style.left = left + 'px';
            tooltipEl.style.top = top + 'px';
            tooltipEl.style.opacity = '1';
        }

        function hideTooltip(tooltipEl) {
            tooltipEl.classList.remove('active');
        }

        // SAVINGS BY VENDOR CHART
        function drawSavingsChart() {
            const canvas = document.getElementById('savingsCanvas');
            const container = canvas.parentElement;
            const rect = container.getBoundingClientRect();
            
            canvas.width = rect.width;
            canvas.height = rect.height;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            ctx.clearRect(0, 0, width, height);
            
            const margin = { top: 40, right: 40, bottom: 80, left: 80 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;
            
            const maxValue = Math.max(...glasswareData.vendors.map(v => v.savings));
            const barWidth = chartWidth / glasswareData.vendors.length * 0.65;
            const spacing = chartWidth / glasswareData.vendors.length;
            const colors = ['#ed8936', '#48bb78', '#805ad5'];
            
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 1;
            ctx.font = '11px Arial';
            ctx.fillStyle = '#718096';
            ctx.textAlign = 'right';
            
            for (let i = 0; i <= 5; i++) {
                const value = (maxValue / 5) * i;
                const y = margin.top + chartHeight - (chartHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(margin.left, y);
                ctx.lineTo(width - margin.right, y);
                ctx.stroke();
                ctx.fillText(`₹${(value/100000).toFixed(1)}L`, margin.left - 10, y + 4);
            }
            
            ctx.strokeStyle = '#718096';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(margin.left, margin.top);
            ctx.lineTo(margin.left, margin.top + chartHeight);
            ctx.lineTo(width - margin.right, margin.top + chartHeight);
            ctx.stroke();
            
            const barData = [];
            glasswareData.vendors.forEach((vendor, i) => {
                const barHeight = (vendor.savings / maxValue) * chartHeight;
                const x = margin.left + i * spacing + (spacing - barWidth) / 2;
                const y = margin.top + chartHeight - barHeight;
                
                ctx.fillStyle = colors[i];
                ctx.fillRect(x, y, barWidth, barHeight);
                barData.push({ x, y, width: barWidth, height: barHeight, vendor });
                
                ctx.font = 'bold 12px Arial';
                ctx.fillStyle = colors[i];
                ctx.textAlign = 'center';
                ctx.fillText(`₹${(vendor.savings/100000).toFixed(1)}L`, x + barWidth/2, y - 8);
                
                ctx.font = 'bold 13px Arial';
                ctx.fillStyle = '#2d3748';
                ctx.fillText(vendor.name, x + barWidth/2, margin.top + chartHeight + 25);
                
                ctx.font = '11px Arial';
                ctx.fillStyle = '#718096';
                ctx.fillText(`${vendor.savingsPct}% savings`, x + barWidth/2, margin.top + chartHeight + 42);
            });
            
            const tooltip = document.getElementById('savingsTooltip');
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                let found = false;
                for (const bar of barData) {
                    if (mouseX >= bar.x && mouseX <= bar.x + bar.width &&
                        mouseY >= bar.y && mouseY <= bar.y + bar.height) {
                        const content = `
                            <div class="tooltip-title">${bar.vendor.name} Savings</div>
                            <div class="tooltip-row">
                                <span class="tooltip-label">Total Savings:</span>
                                <span class="tooltip-value">₹${(bar.vendor.savings/100000).toFixed(2)}L</span>
                            </div>
                            <div class="tooltip-row">
                                <span class="tooltip-label">Savings %:</span>
                                <span class="tooltip-value">${bar.vendor.savingsPct}%</span>
                            </div>
                            <div class="tooltip-row">
                                <span class="tooltip-label">Purchase Value:</span>
                                <span class="tooltip-value">₹${(bar.vendor.purchase/10000000).toFixed(2)}Cr</span>
                            </div>
                        `;
                        showTooltip(tooltip, e.clientX, e.clientY, content);
                        found = true;
                        break;
                    }
                }
                if (!found) hideTooltip(tooltip);
            });
            canvas.addEventListener('mouseleave', () => hideTooltip(tooltip));
        }

        // MISSED SAVINGS BY CATEGORY
        function drawMissedCategoryChart() {
            const canvas = document.getElementById('missedCategoryCanvas');
            const container = canvas.parentElement;
            const rect = container.getBoundingClientRect();
            
            canvas.width = rect.width;
            canvas.height = rect.height;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            ctx.clearRect(0, 0, width, height);
            
            const margin = { top: 40, right: 40, bottom: 100, left: 80 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;
            
            const maxValue = Math.max(...missedSavingsData.categories.map(c => c.missed));
            const barWidth = chartWidth / missedSavingsData.categories.length * 0.7;
            const spacing = chartWidth / missedSavingsData.categories.length;
            
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 1;
            ctx.font = '11px Arial';
            ctx.fillStyle = '#718096';
            ctx.textAlign = 'right';
            
            for (let i = 0; i <= 5; i++) {
                const value = (maxValue / 5) * i;
                const y = margin.top + chartHeight - (chartHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(margin.left, y);
                ctx.lineTo(width - margin.right, y);
                ctx.stroke();
                ctx.fillText(`₹${(value/1000).toFixed(0)}K`, margin.left - 10, y + 4);
            }
            
            ctx.strokeStyle = '#718096';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(margin.left, margin.top);
            ctx.lineTo(margin.left, margin.top + chartHeight);
            ctx.lineTo(width - margin.right, margin.top + chartHeight);
            ctx.stroke();
            
            const barData = [];
            missedSavingsData.categories.forEach((cat, i) => {
                const barHeight = (cat.missed / maxValue) * chartHeight;
                const x = margin.left + i * spacing + (spacing - barWidth) / 2;
                const y = margin.top + chartHeight - barHeight;
                
                ctx.fillStyle = '#e53e3e';
                ctx.fillRect(x, y, barWidth, barHeight);
                barData.push({ x, y, width: barWidth, height: barHeight, cat });
                
                ctx.font = 'bold 11px Arial';
                ctx.fillStyle = '#e53e3e';
                ctx.textAlign = 'center';
                ctx.fillText(`₹${(cat.missed/1000).toFixed(0)}K`, x + barWidth/2, y - 8);
                
                ctx.font = '11px Arial';
                ctx.fillStyle = '#2d3748';
                ctx.fillText(cat.name, x + barWidth/2, margin.top + chartHeight + 20);
                
                ctx.font = '10px Arial';
                ctx.fillStyle = '#718096';
                ctx.fillText(`${cat.count} items`, x + barWidth/2, margin.top + chartHeight + 35);
            });
            
            const tooltip = document.getElementById('missedCategoryTooltip');
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                let found = false;
                for (const bar of barData) {
                    if (mouseX >= bar.x && mouseX <= bar.x + bar.width &&
                        mouseY >= bar.y && mouseY <= bar.y + bar.height) {
                        const pct = bar.cat.totalSaving > 0 ? (bar.cat.missed / bar.cat.totalSaving * 100).toFixed(1) : 0;
                        const content = `
                            <div class="tooltip-title">${bar.cat.name}</div>
                            <div class="tooltip-row">
                                <span class="tooltip-label">Missed Savings:</span>
                                <span class="tooltip-value">₹${(bar.cat.missed/1000).toFixed(1)}K</span>
                            </div>
                            <div class="tooltip-row">
                                <span class="tooltip-label">Total Potential:</span>
                                <span class="tooltip-value">₹${(bar.cat.totalSaving/1000).toFixed(1)}K</span>
                            </div>
                            <div class="tooltip-row">
                                <span class="tooltip-label">% Missed:</span>
                                <span class="tooltip-value">${pct}%</span>
                            </div>
                            <div class="tooltip-row">
                                <span class="tooltip-label">Items:</span>
                                <span class="tooltip-value">${bar.cat.count}</span>
                            </div>
                        `;
                        showTooltip(tooltip, e.clientX, e.clientY, content);
                        found = true;
                        break;
                    }
                }
                if (!found) hideTooltip(tooltip);
            });
            canvas.addEventListener('mouseleave', () => hideTooltip(tooltip));
        }

        // TOP 10 MISSED SAVINGS ITEMS
        function drawTopMissedChart() {
            const canvas = document.getElementById('topMissedCanvas');
            const container = canvas.parentElement;
            const rect = container.getBoundingClientRect();
            
            canvas.width = rect.width;
            canvas.height = rect.height;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            ctx.clearRect(0, 0, width, height);
            
            const margin = { top: 40, right: 40, bottom: 40, left: 280 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;
            
            const maxValue = Math.max(...missedSavingsData.topMissed.map(i => i.missed));
            const barHeight = chartHeight / missedSavingsData.topMissed.length * 0.7;
            const spacing = chartHeight / missedSavingsData.topMissed.length;
            
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 1;
            
            const barData = [];
            missedSavingsData.topMissed.forEach((item, i) => {
                const barWidth = (item.missed / maxValue) * chartWidth;
                const x = margin.left;
                const y = margin.top + i * spacing + (spacing - barHeight) / 2;
                
                ctx.fillStyle = '#ed8936';
                ctx.fillRect(x, y, barWidth, barHeight);
                barData.push({ x, y, width: barWidth, height: barHeight, item });
                
                // Item name
                ctx.font = '10px Arial';
                ctx.fillStyle = '#2d3748';
                ctx.textAlign = 'right';
                const shortName = item.name.substring(0, 32);
                ctx.fillText(shortName, margin.left - 10, y + barHeight/2 + 4);
                
                // Value
                ctx.font = 'bold 11px Arial';
                ctx.fillStyle = '#ed8936';
                ctx.textAlign = 'left';
                ctx.fillText(`₹${(item.missed/1000).toFixed(1)}K`, x + barWidth + 5, y + barHeight/2 + 4);
            });
            
            const tooltip = document.getElementById('topMissedTooltip');
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                let found = false;
                for (const bar of barData) {
                    if (mouseX >= bar.x && mouseX <= bar.x + bar.width &&
                        mouseY >= bar.y && mouseY <= bar.y + bar.height) {
                        const content = `
                            <div class="tooltip-title">${bar.item.name}</div>
                            <div class="tooltip-row">
                                <span class="tooltip-label">Missed Savings:</span>
                                <span class="tooltip-value">₹${(bar.item.missed/1000).toFixed(1)}K</span>
                            </div>
                        `;
                        showTooltip(tooltip, e.clientX, e.clientY, content);
                        found = true;
                        break;
                    }
                }
                if (!found) hideTooltip(tooltip);
            });
            canvas.addEventListener('mouseleave', () => hideTooltip(tooltip));
        }

        // SAVINGS REALIZATION DONUT CHART
        function drawSavingsDonutChart() {
            const canvas = document.getElementById('savingsDonutCanvas');
            const container = canvas.parentElement;
            const rect = container.getBoundingClientRect();
            
            canvas.width = rect.width;
            canvas.height = rect.height;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            ctx.clearRect(0, 0, width, height);
            
            // Calculate totals
            const actualSavings = 2615000; // ₹26.15L
            const missedSavings = 946000;  // ₹9.46L
            const total = actualSavings + missedSavings;
            
            const data = [
                { name: 'Actual Savings', value: actualSavings, color: '#48bb78' },
                { name: 'Missed Savings', value: missedSavings, color: '#e53e3e' }
            ];
            
            const centerX = width / 2 - 100;
            const centerY = height / 2;
            const radius = 130;
            const innerRadius = 80;
            
            const sliceData = [];
            let startAngle = -Math.PI / 2;
            
            data.forEach((item, i) => {
                const sliceAngle = (item.value / total) * Math.PI * 2;
                const endAngle = startAngle + sliceAngle;
                
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, startAngle, endAngle);
                ctx.arc(centerX, centerY, innerRadius, endAngle, startAngle, true);
                ctx.closePath();
                ctx.fillStyle = item.color;
                ctx.fill();
                
                sliceData.push({
                    startAngle, endAngle,
                    centerX, centerY, radius, innerRadius,
                    item: item
                });
                
                startAngle = endAngle;
            });
            
            // Center text
            ctx.font = 'bold 24px Arial';
            ctx.fillStyle = '#1a202c';
            ctx.textAlign = 'center';
            ctx.fillText(`₹${(total/100000).toFixed(1)}L`, centerX, centerY - 5);
            ctx.font = '12px Arial';
            ctx.fillStyle = '#718096';
            ctx.fillText('Total Potential', centerX, centerY + 15);
            
            // Legend
            let legendY = 120;
            data.forEach((item, i) => {
                const legendX = centerX + radius + 60;
                ctx.fillStyle = item.color;
                ctx.fillRect(legendX, legendY, 16, 16);
                ctx.font = '13px Arial';
                ctx.fillStyle = '#2d3748';
                ctx.textAlign = 'left';
                ctx.fillText(item.name, legendX + 24, legendY + 12);
                ctx.font = 'bold 13px Arial';
                ctx.fillStyle = '#718096';
                const pct = (item.value/total*100).toFixed(1);
                ctx.fillText(`₹${(item.value/100000).toFixed(2)}L (${pct}%)`, legendX + 24, legendY + 28);
                legendY += 70;
            });
            
            const tooltip = document.getElementById('savingsDonutTooltip');
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                const dx = mouseX - centerX;
                const dy = mouseY - centerY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                const angle = Math.atan2(dy, dx);
                
                let found = false;
                if (distance >= innerRadius && distance <= radius) {
                    for (const slice of sliceData) {
                        let normalizedAngle = angle;
                        if (normalizedAngle < slice.startAngle) {
                            normalizedAngle += Math.PI * 2;
                        }
                        
                        if (normalizedAngle >= slice.startAngle && normalizedAngle <= slice.endAngle) {
                            const pct = (slice.item.value/total*100).toFixed(1);
                            const content = `
                                <div class="tooltip-title">${slice.item.name}</div>
                                <div class="tooltip-row">
                                    <span class="tooltip-label">Amount:</span>
                                    <span class="tooltip-value">₹${(slice.item.value/100000).toFixed(2)}L</span>
                                </div>
                                <div class="tooltip-row">
                                    <span class="tooltip-label">Percentage:</span>
                                    <span class="tooltip-value">${pct}%</span>
                                </div>
                                <div class="tooltip-row">
                                    <span class="tooltip-label">Total Potential:</span>
                                    <span class="tooltip-value">₹${(total/100000).toFixed(2)}L</span>
                                </div>
                            `;
                            showTooltip(tooltip, e.clientX, e.clientY, content);
                            found = true;
                            break;
                        }
                    }
                }
                if (!found) hideTooltip(tooltip);
            });
            
            canvas.addEventListener('mouseleave', () => hideTooltip(tooltip));
        }

        // POPULATE TABLES
        function populateTables() {
            // Top Items Table with Vendor Comparison
            document.getElementById('topItemsTable').innerHTML = `
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Item Name</th>
                        <th>Santosh</th>
                        <th>Global Pharma</th>
                        <th>Dodal</th>
                        <th>Tharmo-24-25</th>
                        <th>J-SIL-24-25</th>
                        <th>Best Vendor</th>
                    </tr>
                </thead>
                <tbody>
                    ${glasswareData.topItems.map((item, i) => {
                        const rates = [
                            { name: 'Santosh', rate: item.santosh },
                            { name: 'Global', rate: item.global },
                            { name: 'Dodal', rate: item.dodal }
                        ];
                        const minVendor = rates.reduce((min, v) => v.rate < min.rate ? v : min);
                        
                        return `
                        <tr>
                            <td><strong>${i + 1}</strong></td>
                            <td>${item.name}</td>
                            <td class="rate-cell ${item.santosh === item.minRate ? 'vendor-best' : ''}">₹${item.santosh.toFixed(2)}</td>
                            <td class="rate-cell ${item.global === item.minRate ? 'vendor-best' : ''}">₹${item.global.toFixed(2)}</td>
                            <td class="rate-cell ${item.dodal === item.minRate ? 'vendor-best' : ''}">₹${item.dodal.toFixed(2)}</td>
                            <td class="rate-cell">₹${item.tharmo.toFixed(0)}</td>
                            <td class="rate-cell">₹${item.jsil.toFixed(0)}</td>
                            <td><span class="vendor-best">${item.vendor}</span></td>
                        </tr>
                    `}).join('')}
                </tbody>
            `;

            // Vendor Table
            document.getElementById('vendorTable').innerHTML = `
                <thead>
                    <tr>
                        <th>Vendor</th>
                        <th>Purchase Value</th>
                        <th>Potential Savings</th>
                        <th>Savings %</th>
                        <th>Recommendation</th>
                    </tr>
                </thead>
                <tbody>
                    ${glasswareData.vendors.map(vendor => `
                        <tr>
                            <td><strong>${vendor.name}</strong></td>
                            <td>₹${(vendor.purchase/10000000).toFixed(2)}Cr</td>
                            <td style="color: #38a169; font-weight: 600;">₹${(vendor.savings/100000).toFixed(2)}L</td>
                            <td><strong>${vendor.savingsPct}%</strong></td>
                            <td>${vendor.name === 'J-SIL' ? '<span class="vendor-best">Recommended</span>' : '-'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
        }

        window.addEventListener('load', () => {
            drawSavingsChart();
            drawMissedCategoryChart();
            drawTopMissedChart();
            drawSavingsDonutChart();
            populateTables();
        });

        window.addEventListener('resize', () => {
            drawSavingsChart();
            drawMissedCategoryChart();
            drawTopMissedChart();
            drawSavingsDonutChart();
        });
    </script>
</body>
</html>
